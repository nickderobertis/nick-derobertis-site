# Notes

Everything is meant to be run with the working directory in
the deploy folder so you may need to `cd deploy`.

# Initial Setup

## Environment Variables

Copy `.env.template` to `.env` and fill in the values.

## AWS Setup

You will need to have an AWS account and then create an IAM
user in that AWS account with the following permissions:

- `IAMFullAccess`
- `AmazonEC2ContainerRegistryFullAccess`
- `CloudWatchFullAccess`
- `AmazonECS_FullAccess`
- `AmazonVPCFullAccess`
- `AmazonRoute53FullAccess`
- `AWSCertificateManagerFullAccess`
- `AWSCloudFormationFullAccess`

Then take that user's access key and secret key and put them in the 
environment variables.

# First Deployment

Run `./initial-deploy.sh`. This will create all the necessary
infrastructure, and if you don't need to change the infrastructure
then it will just stay up from here.

# Future Deployments

After the initial deployment, then the task definition will
be updated by the CD system. Simply pushing code which passes
all the CI checks is enough to update the deployment.

# Delete Deployment

Run `./delete-deploy.sh`. This will remove all the cloud 
infrastructure and existing docker images in the repository,
as if you never deployed it.
This is useful for when changing the cloud infrastructure
or taking down an app entirely to save costs.

# Development of the Deployment Infrastructure

## Run a command in the container

The `./run-docker.sh` script should be used to run one-off commands
in the container to ensure correct setup. It can be passed
`docker run` arguments.

## CloudFormation Stack

Modify `./cdk_files/deploy_cdk_stack.py` to change the CloudFormation
infrastructure.

### Add more Stacks

Add additional classes to  `./cdk_files/deploy_cdk_stack.py` and then
import and instantiate them in `./cdk_files/app.py`.

## Modify Dependencies

Python dependencies are defined in `./build-scripts/setup-aws-cdk.sh`. 
To reinstall dependencies, delete the `./deploy-cdk` folder and the 
next time something is run with `./run-docker.sh` it will
reinstall them. Linux users will need 
to run `sudo chown -R $USER deploy-cdk/` to delete the deploy folder.

## CloudFormation Deletion

If you get any errors when running `./delete-deploy.sh`, additional
necessary cleanup operations before running delete can be added
to `./cdk_files/pre_delete_cdk.py`. 

## `deploy-cdk`

This is the CDK project generated by the container build. It replaces
the main files with those in `./cdk_files`. If you need to 
test anything out on the generated files, Linux users will need 
to run `sudo chown -R $USER deploy-cdk/`. This is only necessary
the first time after the `deploy-cdk` folder is generated.